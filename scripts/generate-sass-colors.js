#!/usr/bin/env node

/**
 * Generate Sass color variables from CSS custom properties
 * Runs before build to ensure _generated-colors.scss exists
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Read index.css
const indexCssPath = path.resolve(__dirname, '../client/src/index.css');
const indexCss = fs.readFileSync(indexCssPath, 'utf-8');

// Extract CSS custom properties
const colors = {};
const varRegex = /--([\w-]+):\s*([\d.]+)\s+([\d.]+)%\s+([\d.]+)%/g;

let match;
while ((match = varRegex.exec(indexCss)) !== null) {
  const [, name, h, s, l] = match;

  // Convert to valid Sass variable name
  const varName = name.replace(/-/g, '_');

  // Convert HSL to HEX
  const hex = hslToHex(parseFloat(h), parseFloat(s), parseFloat(l));

  colors[varName] = {
    hsl: `hsl(${h} ${s}% ${l}%)`,
    hex: hex
  };
}

// HSL to HEX conversion
function hslToHex(h, s, l) {
  l /= 100;
  const a = s * Math.min(l, 1 - l) / 100;
  const f = n => {
    const k = (n + h / 30) % 12;
    const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
    return Math.round(255 * color).toString(16).padStart(2, '0');
  };
  return `#${f(0)}${f(8)}${f(4)}`;
}

// Generate Sass file
const sassContent = `/**
 * AUTO-GENERATED COLOR VARIABLES
 *
 * DO NOT EDIT THIS FILE MANUALLY!
 * Generated from CSS custom properties in index.css
 *
 * Generated: ${new Date().toISOString()}
 * Source: scripts/generate-sass-colors.js
 */

// =============================================================================
// COLOR VARIABLES (HSL Format for Manipulation)
// =============================================================================

${Object.entries(colors).map(([name, { hsl, hex }], index) => {
  // Group colors by prefix
  if (index === 0 || !Object.keys(colors)[index - 1].startsWith(name.split('_')[0])) {
    const prefix = name.split('_')[0];
    const label = prefix.charAt(0).toUpperCase() + prefix.slice(1);
    return `// ${label} Colors\n$color_${name}_hsl: ${hsl};\n$color_${name}: ${hex};`;
  }
  return `$color_${name}_hsl: ${hsl};\n$color_${name}: ${hex};`;
}).join('\n')}


// =============================================================================
// USAGE NOTES
// =============================================================================
//
// Each color has two variables:
// - $color_primary_hsl: For color manipulation (lighten, darken, adjust)
// - $color_primary: HEX value for CSS output
//
// Example:
//   background: $color_primary;                    // Use HEX for output
//   background: lighten($color_primary_hsl, 10%);  // Use HSL for manipulation
//
// =============================================================================
`;

// Write generated file
const outputPath = path.resolve(__dirname, '../client/src/styles/_generated-colors.scss');
fs.writeFileSync(outputPath, sassContent, 'utf-8');

console.log(`✅ Generated ${Object.keys(colors).length} Sass color variables → ${outputPath}`);
